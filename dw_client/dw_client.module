<?php

/**
 * Implements hook_menu().
 */
function dw_client_menu() {
  $items = array();
  $items['admin/config/system/watchtower_client'] = array(
    'title' => 'Drupal Watchtower settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dw_client_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'dw_client.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_cron().
 */
function dw_client_cron() {
  if ($watchtower = variable_get('watchtower_server', FALSE)) {
    module_load_include('inc', 'dw_client', 'dw_client.api');
    $modules = dw_client_loaded_modules();

    $instance_report = array(
      'watchtower_key' => md5(drupal_get_private_key()),
      'drupal_root' => DRUPAL_ROOT,
      'modules' => $modules,
      'metrics' => module_invoke_all('dw_metric'),
    );

    $result = xmlrpc($watchtower, array(
      'drupal_watchtower.report' => array($instance_report),
    ));

    if (!$result) {
      watchdog('dw_client', xmlrpc_error_msg(), array(), WATCHDOG_ERROR);
    }

    variable_set('watchtower_instance_info_url', $result);
  }
}

/**
 * Implements hook_modules_enabled().
 */
function dw_client_modules_enabled($modules) {
  if (variable_get('watchtower_on_modules_events', FALSE)) {
    dw_client_cron();
  }
}

/**
 * Implements hook_modules_disabled().
 */
function dw_client_modules_disabled($modules) {
  if (variable_get('watchtower_on_modules_events', FALSE)) {
    dw_client_cron();
  }
}

/**
 * Implements hook_dw_metric().
 */
function dw_client_dw_metric() {
  module_load_include('inc', 'dw_client', 'dw_client.metric');
  $metrics = array(
    'current_time' => time(),
    'php_memory_limit' => _return_bytes(ini_get('memory_limit')),
    'greatest_user_id' => dw_client_greatest_user_id(),
    'greatest_watchdog_id' => dw_client_greatest_watchdog_id(),
  );

  return $metrics;
}
